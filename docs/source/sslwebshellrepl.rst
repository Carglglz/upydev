WebSocket (ws) / WebSocket Secure (wss) TLS
===========================================


Steps to enable encryption mode
-------------------------------

1. **Put** ``wss_repl.py`` and ``wss_helper.py`` **in the device**: to do this use ``update_upyutils`` command as:

  .. code-block:: console

      $ upydev update_upyutils

 This will upload :

 * ``sync_tool.py``
 * ``nanoglob.py``
 * ``shasum.py``
 * ``upylog.py``
 * ``upynotify.py``
 * ``uping.py``
 * ``upysecrets.py`` (to enable random WebREPL passwords generation)
 * ``upysh2.py`` (to enable 'tree'  and 'du' command)
 * ``wss_repl.py`` (to enable WebSecureREPL)
 * ``wss_helper.py`` (to enable WebSecureREPL)

2. **Generate ECDSA private key and self-signed certificate**  then **upload it to the device**:

   **This needs openssl to be installed/available at $PATH**

   To generate the key do:

   .. code-block:: console

      $ upydev kg ssl -tfkey

   ``-tfkey`` option is to send the key to the device (so use this if connected directly to the AP of the device or a "secure" wifi e.g. local/home) If not connected to a "secure" wifi upload the key (it is stored in upydev.\__path__) by USB/Serial connection.

   This will ask to set a passphrase, **Do not forget it because it will be needed to log into WebSecureREPL**


3. **Enable WebSecREPL in device**

  Replace ``import webrepl`` for ``import wss_repl`` and ``webrepl.start()`` by
  ``wss_repl.start(ssl=True)``, in ``boot.py`` or ``main.py``.



After these three steps encryption mode is now available:

.. code-block:: console

    $ upydev shl

Or if the global group ``UPY_G`` is configured already, any device can be accessed with this mode using:


.. code-block:: console

    $ upydev shl@[DEVICE]


e.g.

.. code-block:: console

    mbp@cgg:~$ upydev shl@esp_room1
    Enter passphrase for key 'SSL_key30aea4233564.pem':
    WebSecREPL with TLSv1.2 connected
    TLSv1.2 @ ECDHE-ECDSA-AES128-CCM8 - 128 bits Encryption

    MicroPython v1.18-165-g795370ca2-dirty on 2022-03-01; ESP32 module with ESP32
    Type "help()" for more information.

    - CTRL-k to see keybindings or -h to see help
    - CTRL-s to toggle shell/repl mode
    - CTRL-x or "exit" to exit
    esp32@esp_room1:~ $

.. note::

  Once WebSecREPL is enabled, device configuration can be updated with passphrase
  as ``-p [password]:[passphrase]`` so it's not needed for logging anymore.

  .. code-block::

      $upydev config -t esp_room1.local -p mypasswd:mypassphr -@ esp_room1 -gg


WebSecureREPL protocol
----------------------

* **TLSv1.2 @ ECDHE-ECDSA-AES128-CCM8 - 128 bits Encryption**

* **Cipher (ECDHE-ECDSA-AES128-CCM8)128 bits** (recommended for embedded devices) `Check Security State <https://ciphersuite.info/cs/TLS_ECDHE_ECDSA_WITH_AES_128_CCM_8/>`_

* **ECDSA private key and self-signed certificate:** The key and certificate is generated by the host and then uploaded to the device. This will allow Server-client authentication
